<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw Racing Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        #gameContainer {
            position: relative;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        canvas {
            display: block;
            cursor: crosshair;
        }
        
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        #mainMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #f5f5f5 0%, #e8e8e8 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: all;
            z-index: 1000;
        }
        
        #mainMenu.hidden {
            display: none;
        }
        
        .menu-title {
            font-size: 80px;
            font-weight: 900;
            margin-bottom: 50px;
            letter-spacing: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.1;
            position: relative;
        }
        
        .title-draw {
            color: #ff8c00;
            text-shadow: 
                0px 5px 0px #cc7000,
                0px 10px 0px #aa5f00,
                0px 15px 30px rgba(0,0,0,0.4);
            position: relative;
            z-index: 2;
            margin-bottom: 10px;
            animation: titleFloat 3s ease-in-out infinite;
        }
        
        @keyframes titleFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        
        .title-racing {
            color: #000;
            text-shadow: 
                3px 3px 0px #999,
                6px 6px 0px #666,
                9px 9px 30px rgba(0,0,0,0.3);
            position: relative;
            display: inline-block;
        }
        
        .title-racing::before {
            display: none;
        }
        
        .car-icon {
            font-size: 50px;
            display: inline-block;
            vertical-align: baseline;
            margin: 0 5px;
            animation: carBounce 2s ease-in-out infinite;
            position: relative;
            top: 0px;
        }
        
        @keyframes carBounce {
            0%, 100% { transform: translateX(0px) translateY(0px); }
            25% { transform: translateX(3px) translateY(-2px); }
            75% { transform: translateX(-3px) translateY(-2px); }
        }
        
        .menu-subtitle {
            display: none;
        }
        
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 30px;
            align-items: center;
        }
        
        .menu-button {
            padding: 0;
            font-size: 20px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-button:hover {
            transform: translateY(-5px) scale(1.05);
        }
        
        .btn-play {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff8c00 0%, #ff7700 100%);
            box-shadow: 
                0 10px 0px #cc6600,
                0 15px 30px rgba(0,0,0,0.4);
            position: relative;
            margin-bottom: 20px;
            animation: playPulse 2.5s ease-in-out infinite;
        }
        
        @keyframes playPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .btn-play:hover {
            box-shadow: 
                0 15px 0px #cc6600,
                0 20px 35px rgba(0,0,0,0.5);
        }
        
        .btn-play:active {
            transform: translateY(-2px);
            box-shadow: 
                0 7px 0px #cc6600,
                0 12px 25px rgba(0,0,0,0.4);
        }
        
        .btn-play::before {
            content: '‚ñ∂';
            color: white;
            font-size: 60px;
            text-shadow: 3px 3px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding-left: 8px;
        }
        
        .btn-levels {
            background: transparent;
            color: #666;
            font-size: 18px;
            padding: 10px 20px;
            text-decoration: underline;
        }
        
        .btn-levels:hover {
            color: #ff8c00;
            transform: scale(1.05);
        }
        
        .btn-back {
            background: linear-gradient(135deg, #ff8c00 0%, #ff7700 100%);
            color: white;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 50px;
            box-shadow: 
                0 5px 0px #cc6600,
                0 8px 20px rgba(0,0,0,0.3);
        }
        
        .btn-back:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 8px 0px #cc6600,
                0 11px 25px rgba(0,0,0,0.4);
        }
        
        #levelSelect {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-height: 80%;
            overflow-y: auto;
        }
        
        #levelSelect.active {
            display: flex;
        }
        
        .level-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
        }
        
        .level-card {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-align: center;
            min-width: 140px;
        }
        
        .level-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .level-number {
            font-size: 32px;
            font-weight: bold;
            color: #ff8c00;
            margin-bottom: 5px;
        }
        
        .level-name {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .level-stars {
            font-size: 18px;
        }
        
        .car-icon {
            font-size: 50px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
        }
        
        #countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: bold;
            color: #ff6b6b;
            text-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            animation: pulse 1s ease-in-out;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }
        
        #levelInfo {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: bold;
            color: #333;
        }
        
        #starCount {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,215,0,0.9);
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: bold;
            color: #333;
        }
        
        #message {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #f0f0f0 0%, #e0e0e0 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: all;
            z-index: 999;
        }
        
        .message-title-big {
            font-size: 48px;
            font-weight: 900;
            color: #7a7a7a;
            text-shadow: 
                3px 3px 0px #5a5a5a,
                5px 5px 10px rgba(0,0,0,0.3);
            margin-bottom: -10px;
            letter-spacing: 3px;
        }
        
        .message-subtitle {
            font-size: 52px;
            font-weight: 900;
            color: #00bfff;
            text-shadow: 
                0px 4px 0px #0099cc,
                0px 8px 0px #0077aa,
                0px 12px 20px rgba(0,0,0,0.4);
            margin-bottom: 30px;
            letter-spacing: 2px;
        }
        
        .car-display {
            width: 120px;
            height: 80px;
            margin: 20px 0;
            position: relative;
        }
        
        .car-body {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff4500 0%, #ff6347 100%);
            border-radius: 10px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .car-window {
            position: absolute;
            top: 15px;
            left: 20px;
            width: 35px;
            height: 20px;
            background: #34495e;
            border-radius: 3px;
        }
        
        .car-wheel {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #2c2c2c;
            border-radius: 50%;
            border: 3px solid #444;
            bottom: -5px;
        }
        
        .car-wheel.left { left: 15px; }
        .car-wheel.right { right: 15px; }
        
        .stars-display {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            justify-content: center;
        }
        
        .star-item {
            width: 70px;
            height: 70px;
            position: relative;
            animation: starPop 0.5s ease-out;
        }
        
        .star-item.collected {
            animation: starPop 0.5s ease-out, starShine 2s ease-in-out infinite;
        }
        
        @keyframes starPop {
            0% { transform: scale(0) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }
        
        @keyframes starShine {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }
        
        .star-icon {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .star-icon::before {
            content: '‚≠ê';
            font-size: 60px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .star-item.empty .star-icon::before {
            content: '‚≠ê';
            filter: grayscale(100%) brightness(0.5);
        }
        
        .star-icon::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, rgba(255,215,0,0.3) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        .action-buttons {
            display: flex;
            gap: 30px;
            margin-top: 40px;
            align-items: center;
        }
        
        .round-button {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            transition: all 0.3s;
            box-shadow: 
                0 8px 0px rgba(0,0,0,0.2),
                0 12px 20px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .round-button:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 13px 0px rgba(0,0,0,0.2),
                0 17px 25px rgba(0,0,0,0.4);
        }
        
        .round-button:active {
            transform: translateY(-2px);
            box-shadow: 
                0 5px 0px rgba(0,0,0,0.2),
                0 9px 15px rgba(0,0,0,0.3);
        }
        
        .btn-home {
            background: linear-gradient(135deg, #7a7a7a 0%, #5a5a5a 100%);
        }
        
        .btn-replay {
            background: linear-gradient(135deg, #7a7a7a 0%, #5a5a5a 100%);
        }
        
        .btn-continue {
            background: linear-gradient(135deg, #00bfff 0%, #0099cc 100%);
            width: 110px;
            height: 110px;
            font-size: 50px;
        }
        
        .btn-continue::before {
            content: '‚ñ∂';
            color: white;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .btn-home::before {
            content: '';
            display: block;
            width: 40px;
            height: 40px;
            background: white;
            clip-path: polygon(50% 0%, 100% 35%, 100% 100%, 70% 100%, 70% 60%, 30% 60%, 30% 100%, 0% 100%, 0% 35%);
        }
        
        .btn-replay::before {
            content: '‚Üª';
            font-size: 50px;
            color: white;
            font-weight: bold;
        }
        
        #instruction {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            animation: fadeInOut 2s ease-in-out infinite;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="canvas" width="400" height="640"></canvas>
        <div id="ui">
            <div id="mainMenu">
                <div class="menu-title">
                    <div class="title-draw">DRAW</div>
                    <div class="title-racing">
                        RAC<span class="car-icon">üèéÔ∏è</span>NG
                    </div>
                </div>
                <p class="menu-subtitle">Disegna il percorso e vinci!</p>
                
                <div id="mainMenuButtons" class="menu-buttons">
                    <button class="menu-button btn-play" onclick="startGame()"></button>
                    <button class="menu-button btn-levels" onclick="showLevelSelect()">Seleziona Livello</button>
                </div>
                
                <div id="levelSelect">
                    <h2 style="color: #333; margin-bottom: 20px; font-size: 28px;">Scegli il Livello</h2>
                    <div class="level-grid" id="levelGrid"></div>
                    <button class="menu-button btn-back" onclick="showMainMenu()">Indietro</button>
                </div>
            </div>
            
            <div id="levelInfo">Livello: <span id="levelNum">1</span></div>
            <div id="starCount">‚≠ê <span id="stars">0</span></div>
            <div id="countdown"></div>
            <div id="instruction"></div>
            <div id="message">
                <div class="message-title-big" id="messageTitle">LEVEL</div>
                <div class="message-subtitle" id="messageSubtitle">COMPLETE</div>
                
                <div class="car-display">
                    <div class="car-body">
                        <div class="car-window"></div>
                        <div class="car-wheel left"></div>
                        <div class="car-wheel right"></div>
                    </div>
                </div>
                
                <div class="stars-display" id="starsDisplay"></div>
                
                <div class="action-buttons" id="actionButtons"></div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const countdownEl = document.getElementById('countdown');
        const levelNumEl = document.getElementById('levelNum');
        const starsEl = document.getElementById('stars');
        const messageEl = document.getElementById('message');
        const messageTitleEl = document.getElementById('messageTitle');
        const messageSubtitleEl = document.getElementById('messageSubtitle');
        const starsDisplayEl = document.getElementById('starsDisplay');
        const actionButtonsEl = document.getElementById('actionButtons');
        const instructionEl = document.getElementById('instruction');
        const mainMenuEl = document.getElementById('mainMenu');
        const mainMenuButtonsEl = document.getElementById('mainMenuButtons');
        const levelSelectEl = document.getElementById('levelSelect');
        const levelGridEl = document.getElementById('levelGrid');

        // Game state
        let gameState = 'menu'; // menu, countdown, drawing, racing, paused
        let currentLevel = 0;
        let collectedStars = 0;
        let totalStars = 0;
        let drawnPath = [];
        let isDrawing = false;
        let car = { x: 200, y: 600, width: 30, height: 40, angle: 0, speed: 7, pathIndex: 0 };
        let obstacles = [];
        let stars = [];
        let levelProgress = []; // Track completion for each level

        // Menu functions
        function showMainMenu() {
            mainMenuButtonsEl.style.display = 'flex';
            levelSelectEl.classList.remove('active');
        }

        function showLevelSelect() {
            mainMenuButtonsEl.style.display = 'none';
            levelSelectEl.classList.add('active');
            generateLevelGrid();
        }

        function generateLevelGrid() {
            levelGridEl.innerHTML = '';
            levels.forEach((level, index) => {
                const card = document.createElement('div');
                card.className = 'level-card';
                card.onclick = () => startLevel(index);
                
                const progress = levelProgress[index] || { completed: false, stars: 0 };
                const starsDisplay = progress.completed ? '‚≠ê'.repeat(progress.stars) : 'üîí';
                
                card.innerHTML = `
                    <div class="level-number">${index + 1}</div>
                    <div class="level-name">${level.name.split(' - ')[1] || level.name}</div>
                    <div class="level-stars">${starsDisplay}</div>
                `;
                levelGridEl.appendChild(card);
            });
        }

        function startGame() {
            mainMenuEl.classList.add('hidden');
            loadLevel(0);
        }

        function startLevel(levelIndex) {
            mainMenuEl.classList.add('hidden');
            loadLevel(levelIndex);
        }

        function returnToMenu() {
            mainMenuEl.classList.remove('hidden');
            showMainMenu();
            gameState = 'menu';
        }

        // Levels definition
        const levels = [
            {
                name: "Livello 1 - Facile",
                obstacles: [
                    { x: 100, y: 300, width: 200, height: 20 }
                ],
                stars: [
                    { x: 200, y: 400 }
                ]
            },
            {
                name: "Livello 2 - S-Curve",
                obstacles: [
                    { x: 50, y: 450, width: 150, height: 20 },
                    { x: 200, y: 300, width: 150, height: 20 }
                ],
                stars: [
                    { x: 130, y: 500 },
                    { x: 270, y: 350 }
                ]
            },
            {
                name: "Livello 3 - Zigzag",
                obstacles: [
                    { x: 0, y: 500, width: 200, height: 20 },
                    { x: 200, y: 400, width: 200, height: 20 },
                    { x: 0, y: 300, width: 200, height: 20 }
                ],
                stars: [
                    { x: 100, y: 450 },
                    { x: 300, y: 350 },
                    { x: 100, y: 250 }
                ]
            },
            {
                name: "Livello 4 - Slalom",
                obstacles: [
                    { x: 150, y: 500, width: 100, height: 20 },
                    { x: 80, y: 400, width: 80, height: 20 },
                    { x: 240, y: 300, width: 80, height: 20 },
                    { x: 150, y: 200, width: 100, height: 20 }
                ],
                stars: [
                    { x: 50, y: 450 },
                    { x: 200, y: 350 },
                    { x: 350, y: 250 }
                ]
            },
            {
                name: "Livello 5 - Tunnel",
                obstacles: [
                    { x: 0, y: 500, width: 130, height: 20 },
                    { x: 270, y: 500, width: 130, height: 20 },
                    { x: 0, y: 350, width: 130, height: 20 },
                    { x: 270, y: 350, width: 130, height: 20 },
                    { x: 0, y: 200, width: 130, height: 20 },
                    { x: 270, y: 200, width: 130, height: 20 }
                ],
                stars: [
                    { x: 200, y: 450 },
                    { x: 200, y: 300 },
                    { x: 200, y: 150 }
                ]
            },
            {
                name: "Livello 6 - Scale",
                obstacles: [
                    { x: 50, y: 520, width: 100, height: 15 },
                    { x: 250, y: 480, width: 100, height: 15 },
                    { x: 50, y: 420, width: 100, height: 15 },
                    { x: 250, y: 360, width: 100, height: 15 },
                    { x: 50, y: 300, width: 100, height: 15 },
                    { x: 250, y: 240, width: 100, height: 15 },
                    { x: 50, y: 180, width: 100, height: 15 }
                ],
                stars: [
                    { x: 200, y: 450 },
                    { x: 150, y: 330 },
                    { x: 300, y: 210 }
                ]
            },
            {
                name: "Livello 7 - Labirinto",
                obstacles: [
                    { x: 0, y: 500, width: 250, height: 15 },
                    { x: 150, y: 420, width: 250, height: 15 },
                    { x: 0, y: 340, width: 250, height: 15 },
                    { x: 150, y: 260, width: 250, height: 15 },
                    { x: 0, y: 180, width: 250, height: 15 }
                ],
                stars: [
                    { x: 300, y: 460 },
                    { x: 80, y: 380 },
                    { x: 300, y: 300 },
                    { x: 80, y: 220 }
                ]
            },
            {
                name: "Livello 8 - Stretto",
                obstacles: [
                    { x: 0, y: 480, width: 120, height: 25 },
                    { x: 280, y: 480, width: 120, height: 25 },
                    { x: 0, y: 380, width: 120, height: 25 },
                    { x: 280, y: 380, width: 120, height: 25 },
                    { x: 0, y: 280, width: 120, height: 25 },
                    { x: 280, y: 280, width: 120, height: 25 },
                    { x: 0, y: 180, width: 120, height: 25 },
                    { x: 280, y: 180, width: 120, height: 25 }
                ],
                stars: [
                    { x: 200, y: 430 },
                    { x: 200, y: 330 },
                    { x: 200, y: 230 },
                    { x: 200, y: 130 }
                ]
            },
            {
                name: "Livello 9 - Caos",
                obstacles: [
                    { x: 80, y: 520, width: 60, height: 15 },
                    { x: 260, y: 520, width: 60, height: 15 },
                    { x: 170, y: 460, width: 60, height: 15 },
                    { x: 50, y: 400, width: 70, height: 15 },
                    { x: 280, y: 400, width: 70, height: 15 },
                    { x: 150, y: 340, width: 100, height: 15 },
                    { x: 70, y: 280, width: 80, height: 15 },
                    { x: 250, y: 280, width: 80, height: 15 },
                    { x: 130, y: 220, width: 140, height: 15 },
                    { x: 80, y: 160, width: 60, height: 15 },
                    { x: 260, y: 160, width: 60, height: 15 }
                ],
                stars: [
                    { x: 200, y: 490 },
                    { x: 350, y: 430 },
                    { x: 200, y: 370 },
                    { x: 50, y: 310 },
                    { x: 200, y: 250 }
                ]
            },
            {
                name: "Livello 10 - Boss Finale",
                obstacles: [
                    { x: 50, y: 550, width: 100, height: 20 },
                    { x: 250, y: 550, width: 100, height: 20 },
                    { x: 150, y: 490, width: 100, height: 20 },
                    { x: 0, y: 430, width: 120, height: 20 },
                    { x: 280, y: 430, width: 120, height: 20 },
                    { x: 80, y: 370, width: 90, height: 20 },
                    { x: 230, y: 370, width: 90, height: 20 },
                    { x: 150, y: 310, width: 100, height: 20 },
                    { x: 50, y: 250, width: 80, height: 20 },
                    { x: 270, y: 250, width: 80, height: 20 },
                    { x: 120, y: 190, width: 160, height: 20 },
                    { x: 0, y: 130, width: 100, height: 20 },
                    { x: 300, y: 130, width: 100, height: 20 }
                ],
                stars: [
                    { x: 200, y: 520 },
                    { x: 350, y: 460 },
                    { x: 200, y: 400 },
                    { x: 50, y: 340 },
                    { x: 200, y: 280 },
                    { x: 350, y: 220 }
                ]
            }
        ];

        function loadLevel(levelIndex) {
            currentLevel = levelIndex;
            const level = levels[levelIndex];
            
            obstacles = level.obstacles.map(o => ({...o, visible: true}));
            stars = level.stars.map(s => ({...s, radius: 15, collected: false}));
            
            car.x = 200;
            car.y = 600;
            car.angle = 0;
            car.pathIndex = 0;
            
            drawnPath = [];
            isDrawing = false;
            collectedStars = 0;
            totalStars = stars.length;
            
            levelNumEl.textContent = levelIndex + 1;
            starsEl.textContent = `${collectedStars}/${totalStars}`;
            
            startCountdown();
        }

        function startCountdown() {
            gameState = 'countdown';
            let count = 5;
            countdownEl.textContent = count;
            countdownEl.style.display = 'block';
            instructionEl.style.display = 'none';
            
            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownEl.textContent = count;
                    countdownEl.style.animation = 'none';
                    setTimeout(() => {
                        countdownEl.style.animation = 'pulse 1s ease-in-out';
                    }, 10);
                } else {
                    clearInterval(timer);
                    countdownEl.style.display = 'none';
                    startDrawing();
                }
            }, 1000);
        }

        function startDrawing() {
            gameState = 'drawing';
            obstacles.forEach(o => o.visible = false);
            instructionEl.textContent = 'Clicca sopra la macchina e disegna il percorso!';
            instructionEl.style.display = 'block';
        }

        function smoothPath(points, smoothness = 10) {
            if (points.length < 4) return points;
            
            // Reduce density by taking every nth point for control points
            const simplified = [];
            simplified.push(points[0]);
            
            const step = Math.max(1, Math.floor(points.length / 30)); // Keep around 30 control points
            for (let i = step; i < points.length - step; i += step) {
                simplified.push(points[i]);
            }
            simplified.push(points[points.length - 1]);
            
            // Apply Catmull-Rom spline for ultra-smooth curves
            const smoothed = [];
            smoothed.push(simplified[0]);
            
            for (let i = 0; i < simplified.length - 1; i++) {
                const p0 = simplified[Math.max(0, i - 1)];
                const p1 = simplified[i];
                const p2 = simplified[i + 1];
                const p3 = simplified[Math.min(simplified.length - 1, i + 2)];
                
                // Generate smooth curve between p1 and p2
                for (let t = 0; t < 1; t += 1 / smoothness) {
                    const t2 = t * t;
                    const t3 = t2 * t;
                    
                    const x = 0.5 * (
                        (2 * p1.x) +
                        (-p0.x + p2.x) * t +
                        (2 * p0.x - 5 * p1.x + 4 * p2.x - p3.x) * t2 +
                        (-p0.x + 3 * p1.x - 3 * p2.x + p3.x) * t3
                    );
                    
                    const y = 0.5 * (
                        (2 * p1.y) +
                        (-p0.y + p2.y) * t +
                        (2 * p0.y - 5 * p1.y + 4 * p2.y - p3.y) * t2 +
                        (-p0.y + 3 * p1.y - 3 * p2.y + p3.y) * t3
                    );
                    
                    smoothed.push({ x, y });
                }
            }
            
            smoothed.push(simplified[simplified.length - 1]);
            return smoothed;
        }

        function drawFinishLine() {
            const squareSize = 20;
            for (let x = 0; x < canvas.width; x += squareSize) {
                ctx.fillStyle = (x / squareSize) % 2 === 0 ? '#000' : '#fff';
                ctx.fillRect(x, 20, squareSize, 30);
                ctx.fillRect(x, 20 + squareSize, squareSize, 10);
            }
        }

        function drawCar() {
            ctx.save();
            ctx.translate(car.x, car.y);
            ctx.rotate(car.angle);
            
            // Car body
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(-car.width / 2, -car.height / 2, car.width, car.height);
            
            // Windows
            ctx.fillStyle = '#34495e';
            ctx.fillRect(-car.width / 2 + 5, -car.height / 2 + 5, car.width - 10, 12);
            
            // Wheels
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(-car.width / 2 - 3, -car.height / 2 + 5, 4, 8);
            ctx.fillRect(car.width / 2 - 1, -car.height / 2 + 5, 4, 8);
            ctx.fillRect(-car.width / 2 - 3, car.height / 2 - 13, 4, 8);
            ctx.fillRect(car.width / 2 - 1, car.height / 2 - 13, 4, 8);
            
            ctx.restore();
        }

        function drawObstacles() {
            obstacles.forEach(obs => {
                if (obs.visible || gameState === 'countdown') {
                    ctx.fillStyle = '#95a5a6';
                    ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
                    
                    ctx.strokeStyle = '#7f8c8d';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(obs.x, obs.y, obs.width, obs.height);
                }
            });
        }

        function drawStars() {
            stars.forEach(star => {
                if (!star.collected) {
                    ctx.save();
                    ctx.translate(star.x, star.y);
                    ctx.rotate(Date.now() / 500);
                    
                    ctx.fillStyle = '#f1c40f';
                    ctx.strokeStyle = '#f39c12';
                    ctx.lineWidth = 2;
                    
                    ctx.beginPath();
                    for (let i = 0; i < 5; i++) {
                        const angle = (i * 4 * Math.PI) / 5 - Math.PI / 2;
                        const x = Math.cos(angle) * star.radius;
                        const y = Math.sin(angle) * star.radius;
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    
                    ctx.restore();
                }
            });
        }

        function drawPath() {
            if (drawnPath.length < 2) return;
            
            ctx.save();
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 10;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.shadowColor = 'rgba(52, 152, 219, 0.3)';
            ctx.shadowBlur = 5;
            
            ctx.beginPath();
            ctx.moveTo(drawnPath[0].x, drawnPath[0].y);
            for (let i = 1; i < drawnPath.length; i++) {
                ctx.lineTo(drawnPath[i].x, drawnPath[i].y);
            }
            ctx.stroke();
            ctx.restore();
        }

        function checkCollision() {
            // Check obstacles
            for (let obs of obstacles) {
                if (car.x > obs.x - car.width / 2 &&
                    car.x < obs.x + obs.width + car.width / 2 &&
                    car.y > obs.y - car.height / 2 &&
                    car.y < obs.y + obs.height + car.height / 2) {
                    return 'crash';
                }
            }
            
            // Check stars
            stars.forEach(star => {
                if (!star.collected) {
                    const dist = Math.hypot(car.x - star.x, car.y - star.y);
                    if (dist < star.radius + car.width / 2) {
                        star.collected = true;
                        collectedStars++;
                        starsEl.textContent = `${collectedStars}/${totalStars}`;
                    }
                }
            });
            
            // Check finish line
            if (car.y < 50) {
                return 'win';
            }
            
            return null;
        }

        function updateCar() {
            if (car.pathIndex >= drawnPath.length - 1) {
                // If path ended, continue moving forward in the last direction
                const lastAngle = car.angle - Math.PI / 2; // Convert back from display angle
                car.x += Math.cos(lastAngle) * car.speed;
                car.y += Math.sin(lastAngle) * car.speed;
                
                const collision = checkCollision();
                if (collision === 'crash') {
                    showMessage('üí• Crash!', 'Hai colpito un ostacolo!', 'retry');
                } else if (collision === 'win') {
                    const perfect = collectedStars === totalStars ? ' Perfetto! üåü' : '';
                    showMessage('üèÅ Vittoria!' + perfect, 
                        `Hai raccolto ${collectedStars}/${totalStars} stelle!`, 
                        currentLevel < levels.length - 1 ? 'next' : 'complete');
                }
                return;
            }
            
            const current = drawnPath[car.pathIndex];
            const target = drawnPath[car.pathIndex + 1];
            
            const dx = target.x - car.x;
            const dy = target.y - car.y;
            const distance = Math.hypot(dx, dy);
            
            // Always update angle to point in direction of movement
            if (distance > 0.1) {
                car.angle = Math.atan2(dy, dx) + Math.PI / 2;
            }
            
            if (distance < car.speed) {
                car.pathIndex++;
                if (car.pathIndex >= drawnPath.length - 1) return;
            } else {
                // Move car smoothly along path
                car.x += (dx / distance) * car.speed;
                car.y += (dy / distance) * car.speed;
            }
            
            const collision = checkCollision();
            if (collision === 'crash') {
                showMessage('üí• Crash!', 'Hai colpito un ostacolo!', 'retry');
            } else if (collision === 'win') {
                const perfect = collectedStars === totalStars ? ' Perfetto! üåü' : '';
                showMessage('üèÅ Vittoria!' + perfect, 
                    `Hai raccolto ${collectedStars}/${totalStars} stelle!`, 
                    currentLevel < levels.length - 1 ? 'next' : 'complete');
            }
        }

        function showMessage(title, text, type) {
            gameState = 'paused';
            
            // Clear previous content
            starsDisplayEl.innerHTML = '';
            actionButtonsEl.innerHTML = '';
            
            // Set title and subtitle
            if (type === 'next' || type === 'complete') {
                messageTitleEl.textContent = 'LEVEL';
                messageSubtitleEl.textContent = 'COMPLETE';
                messageSubtitleEl.style.color = '#00bfff';
                
                // Save progress
                levelProgress[currentLevel] = {
                    completed: true,
                    stars: collectedStars
                };
                
                // Create stars display
                for (let i = 0; i < totalStars; i++) {
                    const starItem = document.createElement('div');
                    starItem.className = i < collectedStars ? 'star-item collected' : 'star-item empty';
                    starItem.style.animationDelay = `${i * 0.15}s`;
                    starItem.innerHTML = '<div class="star-icon"></div>';
                    starsDisplayEl.appendChild(starItem);
                }
                
                // Create buttons - Home first
                const homeBtn = document.createElement('button');
                homeBtn.className = 'round-button btn-home';
                homeBtn.onclick = () => {
                    messageEl.style.display = 'none';
                    returnToMenu();
                };
                actionButtonsEl.appendChild(homeBtn);
                
                // Continue button in the middle (if not last level)
                if (type === 'next') {
                    const continueBtn = document.createElement('button');
                    continueBtn.className = 'round-button btn-continue';
                    continueBtn.onclick = () => {
                        messageEl.style.display = 'none';
                        loadLevel(currentLevel + 1);
                    };
                    actionButtonsEl.appendChild(continueBtn);
                }
                
                // Replay button last
                const replayBtn = document.createElement('button');
                replayBtn.className = 'round-button btn-replay';
                replayBtn.onclick = () => {
                    messageEl.style.display = 'none';
                    loadLevel(currentLevel);
                };
                actionButtonsEl.appendChild(replayBtn);
                
            } else if (type === 'retry') {
                // Crash screen
                messageTitleEl.textContent = 'LEVEL';
                messageSubtitleEl.textContent = 'FAILED';
                messageSubtitleEl.style.color = '#ff4500';
                
                // Show no stars
                for (let i = 0; i < 3; i++) {
                    const starItem = document.createElement('div');
                    starItem.className = 'star-item empty';
                    starItem.innerHTML = '<div class="star-icon"></div>';
                    starsDisplayEl.appendChild(starItem);
                }
                
                // Create buttons
                const homeBtn = document.createElement('button');
                homeBtn.className = 'round-button btn-home';
                homeBtn.onclick = () => {
                    messageEl.style.display = 'none';
                    returnToMenu();
                };
                actionButtonsEl.appendChild(homeBtn);
                
                const replayBtn = document.createElement('button');
                replayBtn.className = 'round-button btn-replay';
                replayBtn.onclick = () => {
                    messageEl.style.display = 'none';
                    loadLevel(currentLevel);
                };
                actionButtonsEl.appendChild(replayBtn);
            }
            
            messageEl.style.display = 'flex';
        }

        function render() {
            if (gameState !== 'menu') {
                ctx.fillStyle = '#ecf0f1';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                drawFinishLine();
                drawObstacles();
                drawStars();
                drawPath();
                drawCar();
                
                if (gameState === 'racing') {
                    updateCar();
                }
            }
            
            requestAnimationFrame(render);
        }

        // Mouse events
        let mouseStartedOnCar = false;

        canvas.addEventListener('mousedown', (e) => {
            if (gameState !== 'drawing') return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Check if click is on car
            const dist = Math.hypot(x - car.x, y - car.y);
            if (dist < 30) {
                mouseStartedOnCar = true;
                isDrawing = true;
                drawnPath = [{ x: car.x, y: car.y }];
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing || !mouseStartedOnCar) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const lastPoint = drawnPath[drawnPath.length - 1];
            const dist = Math.hypot(x - lastPoint.x, y - lastPoint.y);
            
            // Create intermediate points for smoother segments
            if (dist > 3) {
                const numSegments = Math.ceil(dist / 8); // Create a point every 8 pixels
                for (let i = 1; i <= numSegments; i++) {
                    const t = i / numSegments;
                    const segmentX = lastPoint.x + (x - lastPoint.x) * t;
                    const segmentY = lastPoint.y + (y - lastPoint.y) * t;
                    drawnPath.push({ x: segmentX, y: segmentY });
                }
            }
        });

        canvas.addEventListener('mouseup', () => {
            if (isDrawing && mouseStartedOnCar && drawnPath.length > 2) {
                drawnPath = smoothPath(drawnPath);
                car.pathIndex = 0;
                gameState = 'racing';
                instructionEl.style.display = 'none';
            }
            isDrawing = false;
            mouseStartedOnCar = false;
        });

        // Touch events for mobile
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState !== 'drawing') return;
            
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            const dist = Math.hypot(x - car.x, y - car.y);
            if (dist < 30) {
                mouseStartedOnCar = true;
                isDrawing = true;
                drawnPath = [{ x: car.x, y: car.y }];
            }
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!isDrawing || !mouseStartedOnCar) return;
            
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            const lastPoint = drawnPath[drawnPath.length - 1];
            const dist = Math.hypot(x - lastPoint.x, y - lastPoint.y);
            
            // Create intermediate points for smoother segments
            if (dist > 3) {
                const numSegments = Math.ceil(dist / 8); // Create a point every 8 pixels
                for (let i = 1; i <= numSegments; i++) {
                    const t = i / numSegments;
                    const segmentX = lastPoint.x + (x - lastPoint.x) * t;
                    const segmentY = lastPoint.y + (y - lastPoint.y) * t;
                    drawnPath.push({ x: segmentX, y: segmentY });
                }
            }
        });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            if (isDrawing && mouseStartedOnCar && drawnPath.length > 2) {
                drawnPath = smoothPath(drawnPath);
                car.pathIndex = 0;
                gameState = 'racing';
                instructionEl.style.display = 'none';
            }
            isDrawing = false;
            mouseStartedOnCar = false;
        });

        // Start game
        render();
    </script>
</body>
</html>
